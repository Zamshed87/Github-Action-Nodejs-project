---
name: Smart Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Node build step?'
        required: false
        default: 'false'

env:
  CONTAINER_NAME: app-frontend
  BUILD_DIR: ./build

jobs:
  deploy:
    runs-on: [self-hosted, ibos4]

    steps:
      - uses: actions/checkout@v4

      - name: Build assets (conditional)
        if: ${{ !inputs.skip_build }}
        run: |
          docker build \
            --target builder \
            -t temp-builder .
          docker cp $(docker create temp-builder):/app/build ${{ env.BUILD_DIR }}

      - name: Deploy
        run: |
          docker build \
            --network=host \
            -t ${{ env.CONTAINER_NAME }}:latest .
          docker compose down --timeout 2 || true
          docker compose up -d --build

      - name: Verify
        run: |
          sleep 5
          curl -fsS http://localhost/api/health || \
            { docker logs ${{ env.CONTAINER_NAME }}; exit 1; }
