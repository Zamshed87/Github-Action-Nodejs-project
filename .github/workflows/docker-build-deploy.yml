---
name: Optimized Docker Build

on:
  push:
    branches: [main]
  workflow_dispatch: ~

env:
  IMAGE_NAME: app-frontend
  BUILD_ARGS: >
    --build-arg NODE_ENV=production
    --build-arg NODE_OPTIONS=--max_old_space_size=4096

jobs:
  deploy:
    runs-on: [self-hosted, ibos4]
    
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build ${{ env.BUILD_ARGS }} \
            --network=host \
            -t ${{ env.IMAGE_NAME }}:latest .

      - name: Deploy
        run: |
          docker compose down --timeout 2
          docker compose up -d --build

      - name: Verify
        run: |
          sleep 5
          curl -fsS http://localhost || \
            { docker logs $(docker ps -ql); exit 1; }
